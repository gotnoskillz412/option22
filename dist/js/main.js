!function(e){function t(s){if(n[s])return n[s].exports;var o=n[s]={exports:{},id:s,loaded:!1};return e[s].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){n(1),n(20),n(21),n(22),n(10),n(17),n(23),n(16),n(25),n(15),n(12),n(18),e.exports=n(28)},function(e,t,n){"use strict";var s=n(2),o=n(3),r=n(4),i=n(5),a=n(6),u=n(7),c=n(8),f=n(9),l=n(10),d=n(15),p=parseInt(process.env.API_PORT,10)||3e3,m={origin:process.env.BASE_WEB||"*",credentials:!0,optionsSuccessStatus:200},g=s();g.use(o.json()),g.use(o.urlencoded({extended:!1,type:"*/x-www-form-urlencoded"})),g.use(r()),g.use(a({secret:process.env.MY_SECRET,resave:!1,saveUninitialized:!1})),g.use(c(m)),g.use(f({dest:"./uploads/",rename:function(e,t){return t}}).single("file")),g.use("/",d.index),g.use("/auth",d.auth),g.use("/email",d.email),g.use("/profile",l(),d.profile),u.Promise=global.Promise,u.connect(process.env.MONGO_URI),g.use(function(e,t,n){var s=new Error("Not Found");s.status=404,n(s)}),"development"===g.get("env")&&g.use(function(e,t,n){n.status(e.status||500),n.render("error",{message:e.message,error:e})}),g.use(function(e,t,n){n.status(e.status||500),n.render("error",{message:e.message,error:{}})}),g.listen(p,function(){i.info("App listening on port "+p+"...")})},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("winston")},function(e,t){e.exports=require("express-session")},function(e,t){e.exports=require("mongoose")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("multer")},function(e,t,n){"use strict";var s=n(11),o=n(12),r=n(14),i=function(){return function(e,t,n){var i=e.headers.authorization&&e.headers.authorization.split(" ");i=i&&2===i.length&&"bearer"===i[0].toLowerCase()?i[1]:null,i?o.get(r.blacklistPrefix+i,function(o,r){console.log("getting blacklist:",o,r),r?t.status(401).json({message:"Old token provided"}):s.verify(i,process.env.MY_SECRET,function(s,o){console.log("verifying token",s,o),s?t.status(401).json({message:"Failed to authenticate the token"}):(e.decoded=o,n())})}):t.status(401).json({message:"Unauthorized: No token provided"})}};e.exports=i},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,n){"use strict";var s=n(13),o=new s({stdTTL:3600,checkperiod:60});e.exports=o},function(e,t){e.exports=require("node-cache")},function(e,t){e.exports={mongo:{steps:{accountCreate:"account-create",accountDelete:"account-delete",accountFind:"account-find",profileCreate:"profile-create",profileDelete:"profile-delete",profileUpdate:"profile-update",profileFind:"profile-find"}},blacklistPrefix:"option22-token-blacklist-"}},function(e,t,n){"use strict";e.exports={index:n(16),auth:n(17),email:n(23),profile:n(25)}},function(e,t,n){"use strict";var s=n(2),o=s.Router();o.get("/",function(e,t){t.status(200).send("ok")}),e.exports=o},function(e,t,n){"use strict";var s=n(2),o=n(11),r=n(5),i=n(12),a=n(14),u=n(18),c=n(20),f=n(10),l=s.Router();l.post("/register",function(e,t){var n=e.body.username.toLowerCase(),s=e.body.email.toLowerCase();c.findAccount({email:s}).then(function(e){return e?Promise.reject({step:a.mongo.steps.accountCreate,message:"Account with that email already exists.",error:null}):c.findAccount({username:n})}).then(function(t){if(!t){var o=e.body.password,r=u.generateSaltAndHash(o);return c.createAccount({username:n,email:s,salt:r.salt,hash:r.hash})}return Promise.reject({step:a.mongo.steps.accountCreate,message:"Account with that username already exists.",error:null})}).then(function(){return c.createProfile({username:n,email:s})}).then(function(){var e=o.sign({exp:Math.floor(Date.now()/1e3)+3600,data:{username:n,email:s}},process.env.MY_SECRET);t.status(201).json({token:e})}).catch(function(e){e.step===a.mongo.steps.profileCreate?c.removeAccount({email:s}).then(function(){t.status(500).json({message:e.message})}):e.error?(r.error(e.step,e.message,e.error),t.status(500).json({message:e.message})):t.status(400).json({message:e.message})})}),l.post("/login",function(e,t){var n=e.body.username&&e.body.username.toLowerCase(),s=e.body.password;c.findAccount({username:n}).then(function(e){if(e&&u.verifyPassword(s,e.salt,e.hash)){var i=o.sign({exp:Math.floor(Date.now()/1e3)+3600,data:{username:n,email:e.email}},process.env.MY_SECRET);r.info("login success"),t.status(201).json({token:i})}else t.status(401).json({message:"Incorrect username or password"})}).catch(function(e){e.error?(r.error(e.step,e.message,e.error),t.status(500).json({message:e.message})):t.status(400).json({message:e.message})})}),l.get("/logout",f(),function(e,t){var n=e.headers.authorization&&e.headers.authorization.split(" ");n=n&&2===n.length&&"bearer"===n[0].toLowerCase()?n[1]:null,i.set(a.blacklistPrefix+n,!0,function(s,o){s&&e.status(500).json({message:"Failed to log out"}),o&&setTimeout(function(){i.del(a.blacklistPrefix+n)},36e5),e.query.redirect_uri?t.redirect(e.query.redirect_uri,{}):t.status(200).send("ok")})}),e.exports=l},function(e,t,n){"use strict";var s=n(19),o=function(e){return s.randomBytes(Math.ceil(e/2)).toString("hex").slice(0,e)},r=function(e,t){var n=s.createHmac("sha512",t);return n.update(e),n.digest("hex")},i=function(e){var t=o(32);return{salt:t,hash:r(e,t)}},a=function(e,t,n){return r(e,t)===n};e.exports={generateSaltAndHash:i,verifyPassword:a}},function(e,t){e.exports=require("crypto")},function(e,t,n){"use strict";var s=n(21),o=n(14),r=n(5),i=n(22),a=function(e){return new Promise(function(t,n){s.findOne(e,function(e,s){e?n({step:o.mongo.steps.accountFind,message:"Error finding account",error:e}):t(s)})})},u=function(e){return new Promise(function(t,n){new s(e).save(function(s,i){s?n({step:o.mongo.steps.accountCreate,message:"Error creating account",error:s}):(r.info("Successfully created acount for: "+e.email),t(i))})})},c=function(e){return new Promise(function(t,n){s.remove(e,function(s,i){s?n({step:o.mongo.steps.accountDelete,message:"Error deleting account",error:s}):(r.info("Successfully removed acount for: "+e.email),t(i))})})},f=function(e){return new Promise(function(t,n){new i(e).save(function(s,i){s?n({step:o.mongo.steps.profileCreate,message:"Error creating profile",error:s}):(r.info("Successfully created profile for: "+e.email),t(i))})})},l=function(e){return new Promise(function(t,n){i.findOne(e,function(e,s){e?n({step:o.mongo.steps.profileFind,message:"Error finding profile",error:e}):t(s)})})};e.exports={findAccount:a,createAccount:u,removeAccount:c,createProfile:f,findProfile:l}},function(e,t,n){"use strict";var s=n(7),o=s.Schema,r=new o({username:String,email:String,salt:String,hash:String});e.exports=s.model("Account",r)},function(e,t,n){"use strict";var s=n(7),o=s.Schema,r=new o({picture:{data:Buffer,contentType:String},description:String,likes:[String],email:String,username:String});e.exports=s.model("Profile",r)},function(e,t,n){"use strict";var s=n(2),o=n(24),r=n(5),i=s.Router(),a=o.createTransport({service:"Gmail",auth:{user:process.env.SERVICE_EMAIL,pass:process.env.EMAIL_PASSWORD}}),u=function(e,t,n,s,o){var r={from:e+" <"+t+">",to:process.env.SERVICE_EMAIL,replyTo:t,subject:n,html:s};a.sendMail(r,o)};i.post("/",function(e,t){if(e.body.email&&e.body.name&&e.body.subject&&e.body.message){var n="<p>"+e.body.message+"</p>";u(e.body.name,e.body.email,e.body.subject,n,function(e,n){e?(r.error(e),t.status(500).json({message:"Unable to send email at this time."})):(r.info(n),t.status(201).json({message:"Email sent successfully"}))})}else console.log("bad email",e.body),t.status(400).json({message:"Invalid email format"})}),e.exports=i},function(e,t){e.exports=require("nodemailer")},function(e,t,n){(function(e){"use strict";var t=n(2),s=new t.Router,o=n(27),r=n(20);s.get("/",function(e,t){r.findProfile({username:e.decoded.data.username,email:e.decoded.data.email}).then(function(e){var n={profile:e,picture:e.picture.data.toString("base64")};t.status(200).json(n)}).catch(function(){t.status(500).json({message:"Could not find profile"})})}),s.post("/picture",function(e,t){r.findProfile({username:e.decoded.data.username,email:e.decoded.data.email}).then(function(n){n.picture.data=o.readFileSync(e.file.path),n.picture.contentType="image/png",n.save(function(e){e?(console.log(e),t.status(500).json({message:"Error uploading file"})):t.status(200).send("success")})}).catch(function(e){console.log(e),t.status(500).json({message:"Could not find profile"})})}),s.put("/:accountId",function(){}),e=e.exports=s}).call(t,n(26)(e))},function(e,t){"use strict";e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children=[],e.webpackPolyfill=1),e}},function(e,t){e.exports=require("fs")},function(e,t){"use strict"}]);