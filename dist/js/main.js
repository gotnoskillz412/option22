!function(e){function n(t){if(o[t])return o[t].exports;var r=o[t]={exports:{},id:t,loaded:!1};return e[t].call(r.exports,r,r.exports,n),r.loaded=!0,r.exports}var o={};n.m=e,n.c=o,n.p="",n(0)}([function(e,n,o){o(1),o(11),o(19),o(26),o(30),o(18),o(28),o(17),o(8),o(25),o(12),o(14),o(15),o(16),o(23),o(21),e.exports=o(9)},function(e,n,o){"use strict";var t=o(2),r=o(3),s=o(4),a=o(5),i=o(6),u=o(7),c=o(8),l=o(9),f=o(17),d=o(25),g=parseInt(process.env.API_PORT,10)||3e3,m={origin:process.env.BASE_WEB||"*",credentials:!0,optionsSuccessStatus:200},p=a();p.use(t.json()),p.use(t.urlencoded({extended:!1,type:"*/x-www-form-urlencoded"})),p.use(r()),p.use(i({secret:process.env.MY_SECRET,resave:!1,saveUninitialized:!1})),p.use(s(m)),p.use("/",f.index),p.use("/auth",f.auth),p.use("/email",f.email),p.use("/accounts/:accountId/goals",d(),c(),f.goals),p.use("/accounts/:accountId/profiles",d(),c(),f.profile),u.Promise=global.Promise,u.connect(process.env.MONGO_URI),p.use(function(e,n,o){var t=new Error("Not Found");t.status=404,o(t)}),"development"===p.get("env")&&p.use(function(e,n,o){o.status(e.status||500)}),p.use(function(e,n,o){o.status(e.status||500)}),p.listen(g,function(){l.info("app.js","App listening on port "+g+"...")}),e.exports=p},function(e,n){e.exports=require("body-parser")},function(e,n){e.exports=require("cookie-parser")},function(e,n){e.exports=require("cors")},function(e,n){e.exports=require("express")},function(e,n){e.exports=require("express-session")},function(e,n){e.exports=require("mongoose")},function(e,n,o){"use strict";var t=o(7),r=o(9),s=o(11),a=function(){return function(e,n,o){var a=e.params.accountId;t.Types.ObjectId.isValid(a)?s.findAccount({_id:a}).then(function(t){t?(e.account=t,o()):n.status(404).send()}).catch(function(e){r.error("accountExtractor","Error checking account",{error:e}),n.status(500).json({message:"Error finding account"})}):n.status(404).send()}};e.exports=a},function(e,n,o){"use strict";var t=o(10),r=new t.Logger({transports:[new t.transports.Console({colorize:!0,level:"silly",prettyPrint:!0,timestamp:!0}),new t.transports.File({colorize:!0,filename:"logs/log.txt",level:"info",timestamp:!0})]});r.emitErrs=!1,"test"===process.env.NODE_ENV&&(r.remove(t.transports.Console),r.remove(t.transports.File)),e.exports=r},function(e,n){e.exports=require("winston")},function(e,n,o){"use strict";var t=o(12),r=o(13),s=o(14),a=o(9),i=o(15),u=o(16),c=function(e){return new Promise(function(n,o){t.findOne(e,function(e,t){e?o({step:r.mongo.steps.accountFind,message:"Error finding account",error:e}):n(t)})})},l=function(e){return new Promise(function(n,o){new t(e).save(function(t,s){t?o({step:r.mongo.steps.accountCreate,message:"Error creating account",error:t}):(a.info("mongooseHelpers","Successfully created acount for: "+e.email),n(s))})})},f=function(e){return new Promise(function(n,o){t.remove(e,function(t,s){t?o({step:r.mongo.steps.accountDelete,message:"Error deleting account",error:t}):(a.info("mongooseHelpers","Successfully removed acount for: "+e.email),n(s))})})},d=function(e){return new Promise(function(n,o){new i(e).save(function(t,s){t?o({step:r.mongo.steps.profileCreate,message:"Error creating profile",error:t}):(a.info("mongooseHelpers","Successfully created profile for: "+e.email),n(s))})})},g=function(e){return new Promise(function(n,o){i.find(e,function(e,t){e?o({step:r.mongo.steps.profileFindAll,message:"Error finding profiles",error:e}):n(t)})})},m=function(e){return new Promise(function(n,o){i.findOne(e,function(e,t){e?o({step:r.mongo.steps.profileFind,message:"Error finding profile",error:e}):n(t)})})},p=function(e){return new Promise(function(n,o){i.remove(e,function(t,s){t?o({step:r.mongo.steps.profileDelete,message:"Error deleting profile",error:t}):(a.info("mongooseHelpers","Successfully removed profile for: "+e.email),n(s))})})},h=function(e){return new Promise(function(n,o){new s(e).save(function(t,s){t?o({step:r.mongo.steps.goalAdd,message:"Error adding goal",error:t}):(a.info("mongooseHelpers","Successfully goal for profile: "+e.profileId),n(s))})})},v=function(e){return new Promise(function(n,o){s.findOne(e,function(e,t){e?o({step:r.mongo.steps.goalFind,message:"Error finding goal",error:e}):n(t)})})},b=function(e){return new Promise(function(n,o){s.find(e,function(e,t){e?o({step:r.mongo.steps.goalFindAll,message:"Error finding goals",error:e}):n(t)})})},S=function(e){return new Promise(function(n,o){s.remove(e,function(e,t){e?o({step:r.mongo.steps.goalDelete,message:"Error deleting goal",error:e}):(a.info("mongooseHelpers","Successfully removed goal"),n(t))})})},w=function(e){return new Promise(function(n,o){new u(e).save(function(t,s){t?o({step:r.mongo.steps.subgoalAdd,message:"Error adding subgoal",error:t}):(a.info("mongooseHelpers","Successfully subgoal for goal: "+e.goalId),n(s))})})},y=function(e){return new Promise(function(n,o){u.findOne(e,function(e,t){e?o({step:r.mongo.steps.subgoalFind,message:"Error finding subgoal",error:e}):n(t)})})},j=function(e){return new Promise(function(n,o){u.find(e,function(e,t){e?o({step:r.mongo.steps.subgoalFindAll,message:"Error finding subgoals",error:e}):n(t)})})},P=function(e){return new Promise(function(n,o){u.remove(e,function(e,t){e?o({step:r.mongo.steps.subgoalDelete,message:"Error deleting subgoal",error:e}):(a.info("mongooseHelpers","Successfully removed subgoal"),n(t))})})};e.exports={findAccount:c,createAccount:l,removeAccount:f,createProfile:d,findProfile:m,findAllProfiles:g,removeProfile:p,addGoal:h,findGoal:v,findAllGoals:b,removeGoal:S,addSubgoal:w,findSubgoal:y,findAllSubgoals:j,removeSubgoal:P}},function(e,n,o){"use strict";var t=o(7),r=t.Schema,s=new r({email:String,hash:String,salt:String,username:String});e.exports=t.model("Account",s)},function(e,n){e.exports={mongo:{steps:{accountCreate:"account-create",accountDelete:"account-delete",accountFind:"account-find",goalAdd:"goal-add",goalFind:"goal-find",goalFindAll:"goal-find-all",goalDelete:"goal-delete",subgoalAdd:"sub-goal-add",subgoalFind:"sub-goal-find",subgoalFindAll:"sub-goal-find-all",subgoalDelete:"sub-goal-delete",profileCreate:"profile-create",profileDelete:"profile-delete",profileUpdate:"profile-update",profileFind:"profile-find",profileFindAll:"profile-find-all"}},blacklistPrefix:"option22-token-blacklist-"}},function(e,n,o){"use strict";var t=o(7),r=t.Schema,s=new r({profileId:r.Types.ObjectId,description:String,progress:Number,completed:Boolean});e.exports=t.model("Goal",s)},function(e,n,o){"use strict";var t=o(7),r=t.Schema,s=new r({accountId:r.Types.ObjectId,description:String,firstName:String,lastName:String,likes:[String],picture:String});e.exports=t.model("Profile",s)},function(e,n,o){"use strict";var t=o(7),r=t.Schema,s=new r({goalId:r.Types.ObjectId,description:String,complete:Boolean});e.exports=t.model("Subgoal",s)},function(e,n,o){"use strict";e.exports={index:o(18),auth:o(19),email:o(26),profile:o(28),goals:o(30)}},function(e,n,o){"use strict";var t=o(5),r=t.Router();r.get("/",function(e,n){n.status(200).json({ok:!0})}),e.exports=r},function(e,n,o){"use strict";var t=o(5),r=o(20),s=o(8),a=o(21),i=o(13),u=o(23),c=o(9),l=o(11),f=o(25),d=t.Router(),g=new RegExp("(?=^.{8,}$)((?=.*d)|(?=.*W+))(?![.\n])(?=.*[A-Z])(?=.*[a-z]).*$"),m=new RegExp("^([a-zA-Z0-9_]{5,50})$");d.post("/register",function(e,n){var o=e.body.firstName||null,t=e.body.lastName||null,s=e.body.username.toLowerCase(),a=e.body.email.toLowerCase(),f=null;l.findAccount({email:a}).then(function(e){return e?Promise.reject({step:i.mongo.steps.accountCreate,message:"Account with that email already exists.",error:null}):l.findAccount({username:s})}).then(function(n){if(!n){var o=e.body.password;if(!o.match(g))return Promise.reject({step:i.mongo.steps.accountCreate,message:"Password did not meet requirements."});if(!s.match(m))return Promise.reject({step:i.mongo.steps.accountCreate,message:"Username must be alphanumeric and between 5 and 50 characters."});var t=u.generateSaltAndHash(o);return l.createAccount({username:s,email:a,salt:t.salt,hash:t.hash})}return Promise.reject({step:i.mongo.steps.accountCreate,message:"Account with that username already exists.",error:null})}).then(function(e){return f=e,l.createProfile({accountId:e._id,firstName:o,lastName:t})}).then(function(e){var o=r.sign({exp:Math.floor(Date.now()/1e3)+3600,data:{username:s,email:a}},process.env.MY_SECRET);n.status(201).json({token:o,profile:e,account:{email:f.email,username:f.username,_id:f._id}})}).catch(function(e){e.step===i.mongo.steps.profileCreate?l.removeAccount({email:a}).then(function(){n.status(500).json({message:e.message})}):e.error?(c.error("auth",e.message,{error:e.error,step:e.step}),n.status(500).json({message:e.message})):n.status(400).json({message:e.message})})}),d.post("/login",function(e,n){var o=e.body.username&&e.body.username.toLowerCase(),t=e.body.password,s=null;l.findAccount({username:o}).then(function(e){e&&u.verifyPassword(t,e.salt,e.hash)?(s=e,l.findProfile({accountId:s._id}).then(function(e){var t=r.sign({exp:Math.floor(Date.now()/1e3)+3600,data:{username:o,email:s.email}},process.env.MY_SECRET);c.verbose("auth","Login successful",{email:s.email}),n.status(201).json({token:t,profile:e,account:{email:s.email,username:s.username,_id:s._id}})})):n.status(401).json({message:"Incorrect username or password"})}).catch(function(e){e.error?(c.error("auth",e.message,{error:e.error,step:e.step}),n.status(500).json({message:e.message})):n.status(400).json({message:e.message})})}),d.get("/account",f(),function(e,n){l.findAccount({username:e.decoded.data.username}).then(function(e){e?l.findProfile({accountId:e._id}).then(function(o){o?n.status(200).json({account:{email:e.email,username:e.username,_id:e._id},profile:o}):n.status(500).json({message:"Failed to find profile"})}):n.status(500).json({message:"Failed to find account"})}).catch(function(e){e.error?(c.error("auth",e.message,{error:e.error,step:e.step}),n.status(500).json({message:e.message})):n.status(400).json({message:e.message})})}),d.put("/account/:accountId/password",f(),s(),function(e,n){var o=e.body.newPassword,t=e.body.currentPassword;if(e.account&&u.verifyPassword(t,e.account.salt,e.account.hash)){var s=u.generateSaltAndHash(o);e.account.salt=s.salt,e.account.hash=s.hash;var a=r.sign({exp:Math.floor(Date.now()/1e3)+3600,data:{username:e.account.username,email:e.account.email}},process.env.MY_SECRET);e.account.save(function(e,o){e?(c.error("auth","Failed to update password",{error:e}),n.status(500).json({message:"Failed to update password."})):n.status(200).json({token:a,account:{username:o.username,email:o.email,_id:o._id}})})}else n.status(400).json({message:"Incorrect password"})}),d.put("/account/:accountId/update",f(),s(),function(e,n){var o=e.body.username,t=e.body.email;o.match(m)?(e.account.email=t,e.account.username=o,e.account.save(function(e,o){if(e)c.error("auth","Failed to update password",{error:e}),n.status(500).json({message:"Failed to update password."});else{var t=r.sign({exp:Math.floor(Date.now()/1e3)+3600,data:{username:o.username,email:o.email}},process.env.MY_SECRET);n.status(200).json({token:t,account:{username:o.username,email:o.email,_id:o._id}})}})):n.status(400).json({message:"Username must be alphanumeric and between 5 and 50 characters."})}),d.get("/logout",f(),function(e,n){var o=e.headers.authorization&&e.headers.authorization.split(" ");o=o&&2===o.length&&"bearer"===o[0].toLowerCase()?o[1]:null,a.set(i.blacklistPrefix+o,!0,function(t,r){t&&(c.error("auth","Failed to logout",{error:t}),e.status(500).json({message:"Failed to log out"})),r&&setTimeout(function(){a.del(i.blacklistPrefix+o)},36e5),e.query.redirect_uri?n.redirect(302,e.query.redirect_uri):n.status(200).json({ok:!0})})}),e.exports=d},function(e,n){e.exports=require("jsonwebtoken")},function(e,n,o){"use strict";var t=o(22),r=new t({stdTTL:3600,checkperiod:60});e.exports=r},function(e,n){e.exports=require("node-cache")},function(e,n,o){"use strict";var t=o(24),r=function(e){return t.randomBytes(Math.ceil(e/2)).toString("hex").slice(0,e)},s=function(e,n){var o=t.createHmac("sha512",n);return o.update(e),o.digest("hex")},a=function(e){var n=r(32);return{salt:n,hash:s(e,n)}},i=function(e,n,o){return s(e,n)===o};e.exports={generateSaltAndHash:a,verifyPassword:i}},function(e,n){e.exports=require("crypto")},function(e,n,o){"use strict";var t=o(20),r=o(21),s=o(13),a=o(9),i=function(){return function(e,n,o){var i=e.headers.authorization&&e.headers.authorization.split(" ");i=i&&2===i.length&&"bearer"===i[0].toLowerCase()?i[1]:null,i?r.get(s.blacklistPrefix+i,function(r,s){s?n.status(401).json({message:"Old token provided"}):r?(a.error("security","Error retrieving blacklisted tokens",{error:r}),n.status(500).json({message:"Error checking old token"})):t.verify(i,process.env.MY_SECRET,function(t,r){t?n.status(401).json({message:"Failed to authenticate the token"}):(e.decoded=r,o())})}):n.status(401).json({message:"Unauthorized: No token provided"})}};e.exports=i},function(e,n,o){"use strict";var t=o(5),r=o(27),s=o(9),a=t.Router(),i=void 0,u=r.createTransport({service:"Gmail",auth:{user:process.env.SERVICE_EMAIL,pass:process.env.EMAIL_PASSWORD}}),c=function(e,n,o,t,r){var s={from:e+" <"+n+">",to:process.env.SERVICE_EMAIL,replyTo:n,subject:o,html:t};u.sendMail(s,r)},l=function(e){e?(s.error("email","Error sending email",{error:e}),i.status(500).json({message:"Unable to send email at this time."})):(s.info("email","Email sent successfully"),i.status(201).json({message:"Email sent successfully"}))};a.post("/",function(e,n){if(i=null,e.body.email&&e.body.name&&e.body.subject&&e.body.message){var o="<p>"+e.body.message+"</p>";i=n,c(e.body.name,e.body.email,e.body.subject,o,l)}else n.status(400).json({message:"Invalid email format"})}),e.exports=a},function(e,n){e.exports=require("nodemailer")},function(e,n,o){(function(e){"use strict";var n=o(5),t=o(7),r=o(9),s=o(11),a=new n.Router;a.get("/",function(e,n){s.findAllProfiles({accountId:e.account._id}).then(function(e){n.status(200).json({total:e.length,data:e})}).catch(function(e){r.error("profile","Error getting all profiles",{error:e}),n.status(500).json({message:"Could not find profiles"})})}),a.get("/:profileId",function(e,n){t.Types.ObjectId.isValid(e.params.profileId)?s.findProfile({_id:e.params.profileId,accountId:e.account._id}).then(function(e){e?n.status(200).json(e):n.status(404).send()}).catch(function(e){r.error("profile","Error getting specified profile",{error:e}),n.status(500).json({message:"Could not find profile"})}):n.status(404).send()}),a.put("/:profileId",function(e,n){var o=e.body;s.findProfile({_id:e.params.profileId}).then(function(e){Object.keys(o).forEach(function(n){e[n]!==o[n]&&(e[n]=o[n])}),e.save(function(o,t){o?(r.error("profile","Error updating profile",{error:o}),n.status(500).json({message:"Error updating profile"})):(r.verbose("profile","Profile updated successfully",{email:e.email}),n.status(200).json(t))})}).catch(function(e){r.error("profile","Could not find profile",{error:e}),n.status(500).json({message:"Could not find profile"})})}),e=e.exports=a}).call(n,o(29)(e))},function(e,n){"use strict";e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children=[],e.webpackPolyfill=1),e}},function(e,n,o){"use strict";var t=o(5),r=o(9),s=o(11),a=new t.Router;a.get("/",function(e,n){var o=void 0;s.findProfile({accountId:e.account._id}).then(function(e){return s.findAllGoals({profileId:e._id})}).then(function(e){o=JSON.parse(JSON.stringify(e));var n=e.map(function(e){return s.findAllSubgoals({goalId:e._id})});return Promise.all(n)}).then(function(e){o.forEach(function(n,o){n.subgoals=e[o]}),n.status(200).json({total:o.length,data:o})}).catch(function(e){r.error("goals","Error getting goals",e),n.status(500).json({message:"Internal server error retrieving goals"})})}),a.post("/",function(e,n){var o=e.body.subgoals&&JSON.parse(JSON.stringify(e.body.subgoals)),t=void 0;return delete e.body.subgoals,s.addGoal(e.body).then(function(e){t=JSON.parse(JSON.stringify(e));var n=o.map(function(n){return n.goalId=e._id,s.addSubgoal(n)});return Promise.all(n)}).then(function(e){t.subgoals=JSON.parse(JSON.stringify(e))||[],n.status(201).json(t)}).catch(function(e){r.error("goals","Error adding a goal",e),n.status(500).json({message:"Internal server error adding goal"})})}),a.delete("/:goalId",function(e,n){return s.findGoal({_id:e.params.goalId}).then(function(e){return e?s.findAllSubgoals({goalId:e._id}):(n.status(404).send(),Promise.reject(404))}).then(function(e){var n=e.map(function(e){return s.removeSubgoal({_id:e._id})});return Promise.all(n)}).then(function(){return s.removeGoal({_id:e.params.goalId})}).then(function(){n.status(202).send("Deleted")}).catch(function(e){404!==e&&(r.error("goals","Error deleting goal",e),n.status(500).json({message:"Internal server error deleting goal"}))})}),a.get("/:goalId",function(e,n){var o=void 0;return s.findGoal({_id:e.params.goalId}).then(function(e){return e?(o=JSON.parse(JSON.stringify(e)),s.findAllSubgoals({goalId:e._id})):(n.status(404).send(),Promise.reject(404))}).then(function(e){o.subgoals=JSON.parse(JSON.stringify(e))||[],n.status(200).json(o)}).catch(function(e){404!==e&&(r.error("goals","Error getting goal",e),n.status(500).json({message:"Internal server error getting goal"}))})}),a.put("/:goalId",function(e,n){var o=e.body,t=o.subgoals&&JSON.parse(JSON.stringify(o.subgoals)),a=void 0,i=void 0,u=void 0;delete o.subgoals;var c=[],l=void 0,f=void 0;c.push(new Promise(function(n,t){s.findGoal({_id:e.params.goalId}).then(function(e){Object.keys(o).forEach(function(n){e[n]!==o[n]&&(e[n]=o[n])}),e.save(function(e,o){e?t(e):(l=JSON.parse(JSON.stringify(o)),n())})}).catch(t)})),c.push(new Promise(function(e,n){s.findAllSubgoals({goalId:o._id}).then(function(e){a=e.filter(function(e){return!t.find(function(n){return e._id.toString()===n._id.toString()})}),i=t.filter(function(n){return!e.find(function(e){return e._id.toString()===n._id.toString()})}),u=t.filter(function(n){return e.find(function(e){return e._id.toString()===n._id.toString()})}),console.log(i)}).then(function(){var e=u.map(function(e){return new Promise(function(n,t){s.findSubgoal({_id:e._id}).then(function(r){Object.keys(o).forEach(function(n){r[n]!==e[n]&&(r[n]=e[n])}),r.save(function(e,o){e?t(e):n(o)})})})});return Promise.all(e)}).then(function(e){return f=JSON.parse(JSON.stringify(e)),new Promise(function(e,n){a=a.map(function(e){return s.removeSubgoal({_id:e._id})}),Promise.all(a).then(e,n)})}).then(function(){return new Promise(function(e,n){i=i.map(function(e){return s.addSubgoal(e)}),Promise.all(i).then(e,n)})}).then(function(e){f=f.concat(JSON.parse(JSON.stringify(e)))}).then(e).catch(n)})),Promise.all(c).then(function(){l.subgoals=f||[],n.status(200).json(l)}).catch(function(e){r.error("goals","Error updating goal and subgoals",e),n.status(500).json({message:"Internal server error updating goal and subgoals"})})}),e.exports=a}]);